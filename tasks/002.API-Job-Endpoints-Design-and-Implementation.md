# Task 002 — API Job Endpoints (Polling/Claim/Lease/Status)

Objective: Provide the renderer worker with API-based job control: listing, claiming with lease, heartbeats, and status updates.

Endpoints
- [ ] GET /api/render-jobs?status=queued&limit=N → list { id, story_id, part_id }
- [ ] POST /api/render-jobs/{id}/claim body: { lease_seconds } → { lease_expires_at }
- [ ] POST /api/render-jobs/{id}/heartbeat → 200 extends lease
- [ ] POST /api/render-jobs/{id}/status body:
      { status: rendering|rendered|errored, artifact_path?, bytes?, duration_ms?, error_class?, error_message?, stderr_snippet? }

State Machine
- queued → claimed → rendering → rendered|errored
- Invalid transitions return 409 + { allowed_next: [...] }

Implementation Steps
- [ ] Migrations: add lease_expires_at, retries, error_class, error_message, stderr_snippet to jobs.
- [ ] Implement endpoints with bearer auth; RBAC: renderer role.
- [ ] Atomic claim (single UPDATE ... WHERE status='queued' AND (lease_expired OR null)).
- [ ] Heartbeat extends lease_expires_at.
- [ ] Status updates validate transitions and record metadata.
- [ ] Return queue depth in GET for observability.

Tests
- [ ] Unit: transition validator (valid/invalid cases).
- [ ] Integration: two workers try to claim same job → exactly one succeeds.
- [ ] Integration: heartbeat extends lease; timeout flips job back to queued.
- [ ] Contract: renderer worker e2e against a seed job (mock ffmpeg).

Acceptance Criteria
- [ ] Endpoints pass integration tests; concurrency safe; leases enforced.
- [ ] Logs show claims, heartbeats, and status updates with job ids.
